<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Prédiction nutritionnelle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="d-flex">

        <!-- Sidebar -->
        <div class="bg-dark text-white p-3" style="width: 220px; min-height: 100vh;">
            <h4 class="text-center mb-4">MiniML</h4>
            <ul class="nav flex-column gap-2">
                <li class="nav-item"><a class="nav-link text-white" href="/">Accueil</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="/model_info">Model Info</a></li>
                <li class="nav-item"><a class="nav-link text-white fw-bold" href="/predict">Prédiction</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="/diagnostics">Diagnostics</a></li>
            </ul>
        </div>

        <!-- Contenu -->
        <div class="container-fluid p-4">
            <h2 class="mb-4">Prédiction nutritionnelle</h2>

            {% if error %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
            {% endif %}

            <form method="post" class="row g-3">

                {% for col, values in categories.items() %}
                <div class="col-md-4">
                    <label class="form-label">{{ col }}</label>
                    <select name="{{ col }}" class="form-select" required>
                        {% for v in values %}
                        <option value="{{ v }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}

                {% for col in numeric_cols %}
                <div class="col-md-4">
                    <label class="form-label">{{ col }}</label>
                    <input type="number" step="any" name="{{ col }}" class="form-control">
                </div>
                {% endfor %}

                <div class="col-12">
                    <button class="btn btn-primary mt-3">Prédire</button>
                </div>
            </form>

            {% if results %}
            <div class="card mt-4 p-3 shadow-sm">
                <h5>Valeurs nutritionnelles prédites</h5>
                <table class="table table-bordered table-striped mt-3">
                    <thead class="table-dark">
                        <tr>
                            <th>Indicateur</th>
                            <th>Valeur prédite</th>
                            <th>Prédiction moyenne du nom</th>
                            <th>Intervalle de confiance (95%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in results %}
                        <tr>
                            <td>{{ row.name }}</td>
                            <td>{{ "%.2f"|format(row.value) }}</td>
                            <td>{{ "%.2f"|format(row.prediction_moyenne) }}</td>
                            <td>[{{ "%.2f"|format(row.ic_bas) }}, {{ "%.2f"|format(row.ic_haut) }}]</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            {% if prediction_history %}
            <div class="card mt-4 p-3 shadow-sm">
                <h5>Historique des prédictions</h5>

                <div class="table-responsive">
                    <table class="table table-sm table-striped table-bordered mt-3">
                        <thead class="table-secondary">
                            <tr>
                                <th>#</th>
                                <th>Produit</th>
                                {% for col in numeric_cols %}
                                <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in prediction_history %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ item.input["Nom"] }}</td>

                                {% for col in numeric_cols %}
                                <td>
                                    {% if item.input[col] is not none %}
                                    {{ "%.2f"|format(item.input[col]) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                {% endfor %}

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {% if prediction_history %}
            <div class="card mt-4 p-3 shadow-sm">
                <h5>Historique des valeurs prédites</h5>

                <div class="table-responsive">
                    <table class="table table-sm table-striped table-bordered mt-3">
                        <thead class="table-secondary">
<tr>
    <th>#</th>

    {% for name in target_names %}
    <th>{{ name }}</th>
    {% endfor %}

    <th>Imputation</th>   <!-- AJOUT -->
</tr>
                        </thead>
                        <tbody>
                            {% for item in prediction_history %}
<tr>
    <td>{{ loop.index }}</td>

    {% for row in item.results %}
    <td>{{ "%.2f"|format(row.value) }}</td>
    {% endfor %}

    <td>
        {% if item.imputation_used %}
            Oui
        {% else %}
            Non
        {% endif %}
    </td>
</tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {% if prediction_history %}
<div class="mt-4">
    <a href="/export_csv" class="btn btn-success">
        Exporter CSV
    </a>
</div>
{% endif %}
        </div>
    </div>

</body>

</html>